name: Alpenglow Formal Verification

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify-tla:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Java 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Download TLA+ Tools
      run: |
        curl -L -o tla2tools.jar https://github.com/tlaplus/tlaplus/releases/latest/download/tla2tools.jar
        
    - name: Verify MinimalAlpenglow
      run: |
        timeout 30 java -cp tla2tools.jar tlc2.TLC -config model-checking/small-config/MinimalAlpenglow.cfg model-checking/small-config/MinimalAlpenglow.tla || true
        
    - name: Verify AlpenglowConsensus (limited time)
      run: |
        timeout 60 java -cp tla2tools.jar tlc2.TLC -config model-checking/small-config/AlpenglowConsensus.cfg model-checking/small-config/AlpenglowConsensus.tla || true
        
    - name: Run syntax check on all TLA+ specs
      run: |
        for spec in specs/tlaplus/*.tla; do
          echo "Checking syntax of $spec"
          java -cp tla2tools.jar tlc2.TLC -config /dev/null "$spec" || echo "Syntax check failed for $spec"
        done

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check documentation
      run: |
        echo "✅ README.md exists"
        test -f README.md
        echo "✅ LICENSE exists" 
        test -f LICENSE
        echo "✅ Specifications directory exists"
        test -d specs/tlaplus
        echo "✅ Model checking directory exists"
        test -d model-checking/small-config
        
    - name: Count TLA+ specifications
      run: |
        spec_count=$(find specs/tlaplus -name "*.tla" | wc -l)
        echo "Found $spec_count TLA+ specifications"
        test $spec_count -gt 0
        
    - name: Verify project structure
      run: |
        echo "Project structure:"
        find . -type f -name "*.tla" -o -name "*.cfg" -o -name "*.md" | head -20
